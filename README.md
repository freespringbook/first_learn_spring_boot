# 처음 배우는 스프링 부트2
## 5. 스프링 부트 시큐리티 + OAuth2
스프링 부트 프레임워크는 인증과 권한에 관련된 강력한 기능인 스프링 부트 시큐리티를 제공함
스프링 부트 시큐리티는 스프링 시큐리티의 번거로운 설정을 간소화 시켜주는 래핑 프레임워크

## 5.1 배경지식 소개
스프링 부트 시큐리티는 스프링 시큐리티에 스타터를 제공해 더 빠른 설정을 지원하는 프로젝트임

### 1. 스프링 부트 시큐리티
스프링 부트 시큐리티에서 가장 중요한 개념
#### 인증(Authentication)
사용자(클라이언트)가 애플리케이션의 특정 동작에 관하여 허락(인증)된 사용자인지 확인하는 절차
웹사이트 로그인을 인증이라 생각하면 됨

#### 권한부여(Authorization)
데이터나 프로그램 등의 특정 자원이나 서비스에 접근할 수 있는 권한을 허용하는 것
예를 들어 A는 VIP 회원이고, B는 일반 회원이라면 두 회원의 권한이 다르게 부여됨

#### 그외 인증방식
- 크리덴셜(Credential) 기반 인증 방식: 사용자명(Principle)과 비밀번호(Credential)로 인증하는 전통적인 인증 방식
- 이중 인증 방식: OTP와 같이 추가적인 인증 방식을 도입에 한번에 2가지 방법으로 인증하는 방식
- OAuth2 인증 방식: 소셜 미디어를 사용해 편리하게 인증하는 방식

### 2. OAuth2
OAuth는 토큰을 사용한 범용적인 방법의 인증을 제공하는 표준 인증 프로토콜
OAuth2는 OAuth 프로토콜의 버전 2 서드파티(3rd party)를 위한 범용적인 인증 표준

#### OAuth2에서 제공하는 승인 타입 4가지
##### 권한 부여 코드 승인 타입(Authorization Code Grant Type)
클라이언트가 다른 사용자 대신 특정 리소스에 접근을 요청할 때 사용됨
리소스 접근을 위한 사용자명과 비밀번호, 권한 서버에 요청해서 받은 권한 코드를 함께 활용하여 리소스에  
대한 엑세스 토큰을 받으면 이를 인증에 이용하는 방식

페이스북, 구글, 카카오 등의 소셜 미디어 들이 웹 서버 형태의 클라이언트를 이 방식으로 지원  
웹 서버에서 장기 엑세스 토큰(long-lived access token)을 사용하여 사용자 인증을 처리

##### 암시적 승인 타입(Implicit Grant Type)
권한 부여 코드 승인 타입과 다르게 권한 코드 교환 단계 없이 엑세스 토큰을 즉시 반환받아 이를 인증에 이용하는 방식

##### 리소스 소유자 암호 자격 증명 승인 타입(Resource Owner Password Credentials Grant Type)
클라이언트가 암호를 사용하여 엑세스 토큰에 대한 사용자의 자격 증명을 교환하는 방식

##### 클라이언트 자격 증명 승인 타입(Client Credentials Grant Type)
클라이언트가 컨텍스트 외부에서 엑세스 토큰을 얻어 특정 리소스에 접근을 요청할 때 사용하는 방식 

```puml
header Authorization Code Grant Type
title 권한 부여 코드 승인 타입 시퀀스 다이어그램

participant 리소스_주인
클라이언트 -> 권한서버: 권한 부여 코드 요청

activate 권한서버
rnote over 권한서버
  client_id, redirect_url,
  response_type=code의 파라미터로 
  요청하면 코드값 반환
end rnote
리소스_주인 -> 권한서버: 로그인
권한서버 --> 클라이언트: 권한 부여 코드 응답
deactivate 권한서버

클라이언트 -> 권한서버: 엑세스 토큰으로 교환 요청
activate 권한서버
rnote over 권한서버
  client_id, client_secret, redirect_url,
  grant_type=authorization_code를 사용하여 권한 부여 코드 반환
end rnote
클라이언트 <-- 권한서버: 엑세스 토큰 응답
deactivate 권한서버

loop 
  클라이언트 -> 리소스_서버: 엑세스 토큰을 사용하여 API 호출
  activate 리소스_서버
  클라이언트 <-- 리소스_서버: 요청한 데이터 응답
  deactivate 리소스_서버
end
```
![권한 부여 코드 승인 타입 시퀀스 다이어그램](http://bit.ly/2PlTpmz)

- 리소스 주인(resource owner): 인증이 필요한 사용자
- 클라이언트(client): 웹사이트
- 권한 서버(authorization server): 페이스북/구글/카카오 서버
- 리소스 서버(resource server): 페이스북/구글/카카오 서버

1. 클라이언트가 파라미터로 클라이언트 ID, 리다이렉트 URI, 응답 타입을 code로 지정하여 권한서버에 전달  
정상적으로 인증이 되면 권한 부여 코드를 클라이언트에 보냄(응답 타입은 code, token이 사용 가능  
응답 타입이 token일 때가 암시적 승인 타입에 해당함)

2. 성공적으로 권한 부여 코드를 받은 클라이언트는 권한 부여 코드를 사용하여 엑세스 토큰(access token)을  
권한 서버에 추가로 요청함  
이때 필요한 파라미터는 클라이언트 ID(client-id), 클라이언트 비밀번호(client-secret), 리다이렉트 URI, 인증 타입임

3. 마지막으로 응답받은 엑세스 토큰을 사용하여 리소스 서버에 사용자의 데이터를 요청함